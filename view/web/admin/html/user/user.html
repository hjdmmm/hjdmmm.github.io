<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hjdmmm博客后台</title>
  <link href="../../css/global.css" rel="stylesheet">
  <link href="../../css/common-table.css" rel="stylesheet">
</head>
<body>
<div class="container">
  <div class="left-side">
    <ul>
      <li><a href="../article/write.html">写博文</a></li>
      <li><a href="../article/article.html">文章管理</a></li>
      <li><a href="../link/link.html">推荐网站管理</a></li>
      <li><a href="../category/category.html">分类管理</a></li>
      <li><a href="../tag/tag.html">标签管理</a></li>
      <li><a href="./user.html">用户管理</a></li>
      <li><a href="../image/image.html">图片管理</a></li>
      <li><a href="../drawio/drawio.html">drawio管理</a></li>
    </ul>
  </div>
  <div class="center">
    <div class="inner-header">
      <h1>用户管理</h1>
      <input type="button" value="退出" onclick="logout('../user/login.html');">
    </div>
    <div class="inner-center">
      <div class="search">
        <span class="search-tip">用户名称</span> <input class="search-text" id="name" type="text">
        <span class="search-tip">类型</span>
        <select id="type">
          <option value="-1">未选择</option>
          <option value="0">普通用户</option>
          <option value="1">管理员用户</option>
        </select>
        <span class="search-tip">状态</span>
        <select id="status">
          <option value="-1">未选择</option>
          <option value="0">正常</option>
          <option value="1">禁用</option>
        </select>
        <input class="search-button" id="search" type="button" value="搜索">
      </div>

      <div>
        <input class="add-button" onclick="window.location.href = 'add_user.html';" type="button" value="新增">
      </div>

      <div class="table">
        <table>
          <thead>
          <tr>
            <th>用户id</th>
            <th>用户名称</th>
            <th>用户昵称</th>
            <th>类型</th>
            <th>状态</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="user-list">
          </tbody>
        </table>
      </div>

      <div class="page-board">
        共<span id="total-num">0</span>条 10条/页
        <input class="page-button" id="previous-page" onclick="pager.toPreviousPage();" type="button" value="&lt;">
        <span id="show-page-num">
        </span>
        <input class="page-button" id="next-page" onclick="pager.toNextPage();" type="button" value="&gt;">
        前往 <input class="page-num" id="selected-page-num" type="text"> 页
      </div>
    </div>
  </div>
</div>
</body>
</html>

<script src="../../js/ajax.js"></script>
<script src="../../js/page.js"></script>
<script src="../../js/login.js"></script>
<script>
  const pageSize = 10;
  let pager;

  const onChangePageNum = function (e) {
    const theEvent = window.event || e;
    const code = theEvent.keyCode || theEvent.which || theEvent.charCode;
    if (code === 13) {
      pager.toSelectedPageNum(this.value);
    }
  }

  const showList = function (page) {
    document.getElementById("total-num").innerText = page.total;
    const showPageNumEle = document.getElementById("show-page-num");
    showPageNumEle.innerHTML = '';
    for (let currentPage = 1; currentPage <= pager.maxPageNum; currentPage++) {
      const pageNumEle = document.createElement("input");
      pageNumEle.className = "page-button";
      pageNumEle.type = "button";
      pageNumEle.value = currentPage.toString();
      const currentPageNum = currentPage;
      pageNumEle.onclick = function () {
        pager.toSelectedPageNum(currentPageNum);
      }
      showPageNumEle.appendChild(pageNumEle);
    }

    showTable(page.rows)
  }

  const showTable = function (list) {
    const userListEle = document.getElementById("user-list");
    userListEle.innerHTML = "";
    for (let user of list) {
      const id = user.id;
      const elementNames = ["id", "userName", "nickName", "type", "status", "createTime", "op"];
      const tdEles = elementNames.map(elementName => {
        const tdEle = document.createElement("td");
        tdEle.innerText = user[elementName];
        return tdEle;
      });

      let typeStr;
      switch (user.type) {
        case 0:
          typeStr = "普通用户";
          break;
        case 1:
          typeStr = "管理员";
          break;
        default:
          typeStr = "非法类型";
          break;
      }
      tdEles[3].innerText = typeStr;

      const statusButton = document.createElement("input");
      statusButton.type = "checkbox";
      statusButton.className = "table-slide-button";
      if (user.status === 0) {
        statusButton.setAttribute("checked", "true");
      }
      statusButton.onclick = function () {
        statusButton.disabled = true;
        const checked = this.getAttribute("checked") != null;
        const param = {
          'id': id,
          'status': checked ? 1 : 0,
        }
        ajax.put("admin/user/status", param, function () {
          if (checked) {
            statusButton.removeAttribute("checked");
          } else {
            statusButton.setAttribute("checked", "true");
          }
          statusButton.disabled = false;
        });
      }
      tdEles[4].innerHTML = '';
      tdEles[4].appendChild(statusButton);

      tdEles[6].innerHTML = '';

      const editButton = document.createElement("input");
      editButton.type = "button";
      editButton.className = "table-button";
      editButton.value = "修改";
      editButton.onclick = function () {
        window.location.href = "edit_user.html?id=" + id;
      }
      tdEles[6].appendChild(editButton);

      const removeButton = document.createElement("input");
      removeButton.type = "button";
      removeButton.className = "table-button";
      removeButton.value = "删除";
      removeButton.onclick = function () {
        if (window.confirm("确认删除id为" + id + "的用户吗？")) {
          ajax.delete("admin/user/" + id, null, function () {
            window.location.reload();
          });
        }
      }
      tdEles[6].appendChild(removeButton);

      const trEle = document.createElement("tr");
      for (let tdEle of tdEles) {
        trEle.appendChild(tdEle);
      }
      userListEle.appendChild(trEle);
    }
  }

  const search = function () {
    let name = document.getElementById("name").value;
    name = name == null || name === "" ? null : name;
    const statusEle = document.getElementById("status");
    let status = statusEle.options[statusEle.selectedIndex].value;
    status = status === "-1" ? null : status;
    const typeEle = document.getElementById("type");
    let type = typeEle.options[typeEle.selectedIndex].value;
    type = type === "-1" ? null : type;
    pager.changePageNum(1, new Map([
      ['name', name],
      ['status', status],
      ['type', type],
    ]));
  }

  window.onload = function () {
    if (!existToken()) {
      window.location.href = "../user/login.html";
    }

    pager = new Pager(pageSize, "admin/user/list", showList);
    pager.changePageNum(1);

    document.getElementById("selected-page-num").onkeydown = onChangePageNum;

    document.getElementById("search").onclick = search;
  }
</script>