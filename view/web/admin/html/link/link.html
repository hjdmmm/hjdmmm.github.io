<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hjdmmm博客后台</title>
  <link href="../../css/global.css" rel="stylesheet">
  <link href="../../css/common-table.css" rel="stylesheet">
</head>
<body>
<div class="container">
  <div class="left-side">
    <ul>
      <li><a href="../article/write.html">写博文</a></li>
      <li><a href="../article/article.html">文章管理</a></li>
      <li><a href="./link.html">推荐网站管理</a></li>
      <li><a href="../category/category.html">分类管理</a></li>
      <li><a href="../tag/tag.html">标签管理</a></li>
      <li><a href="../user/user.html">用户管理</a></li>
      <li><a href="../image/image.html">图片管理</a></li>
      <li><a href="../drawio/drawio.html">drawio管理</a></li>
    </ul>
  </div>
  <div class="center">
    <div class="inner-header">
      <h1>推荐网站管理</h1>
      <input type="button" value="退出" onclick="logout('../user/login.html');">
    </div>
    <div class="inner-center">
      <div class="search">
        <span class="search-tip">名称</span> <input class="search-text" id="name" type="text">
        <span class="search-tip">审核状态</span>
        <select id="status">
          <option value="-1">未选择</option>
          <option value="0">审核通过</option>
          <option value="1">审核未通过</option>
          <option value="2">未审核</option>
        </select>
        <input class="search-button" id="search" type="button" value="搜索">
      </div>

      <div>
        <input class="add-button" onclick="window.location.href = 'add_link.html';" type="button" value="新增">
      </div>

      <div class="table">
        <table>
          <thead>
          <tr>
            <th>id</th>
            <th>名称</th>
            <th>描述</th>
            <th>状态</th>
            <th>地址</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="link-list">
          </tbody>
        </table>
      </div>

      <div class="page-board">
        共<span id="total-num">0</span>条 10条/页
        <input class="page-button" id="previous-page" onclick="pager.toPreviousPage();" type="button" value="&lt;">
        <span id="show-page-num">
        </span>
        <input class="page-button" id="next-page" onclick="pager.toNextPage();" type="button" value="&gt;">
        前往 <input class="page-num" id="selected-page-num" type="text"> 页
      </div>
    </div>
  </div>
</div>
</body>
</html>

<script src="../../js/ajax.js"></script>
<script src="../../js/page.js"></script>
<script src="../../js/login.js"></script>
<script>
  const pageSize = 10;
  let pager;

  const onChangePageNum = function (e) {
    const theEvent = window.event || e;
    const code = theEvent.keyCode || theEvent.which || theEvent.charCode;
    if (code === 13) {
      pager.toSelectedPageNum(this.value);
    }
  }

  const showList = function (page) {
    document.getElementById("total-num").innerText = page.total;
    maxPageNum = Math.ceil(page.total / pageSize);
    const showPageNumEle = document.getElementById("show-page-num");
    showPageNumEle.innerHTML = '';
    for (let currentPage = 1; currentPage <= maxPageNum; currentPage++) {
      const pageNumEle = document.createElement("input");
      pageNumEle.className = "page-button";
      pageNumEle.type = "button";
      pageNumEle.value = currentPage.toString();
      const currentPageNum = currentPage;
      pageNumEle.onclick = function () {
        pager.toSelectedPageNum(currentPageNum);
      }
      showPageNumEle.appendChild(pageNumEle);
    }

    showTable(page.rows)
  }

  const showTable = function (list) {
    const linkListEle = document.getElementById("link-list");
    linkListEle.innerHTML = "";
    for (let link of list) {
      const id = link.id;
      const elementNames = ["id", "name", "description", "status", "url", "op"];
      const tdEles = elementNames.map(elementName => {
        const tdEle = document.createElement("td");
        tdEle.innerText = link[elementName];
        return tdEle;
      });

      let statusInfo;
      switch (link.status) {
        case 0:
          statusInfo = "通过"
          break;
        case 1:
          statusInfo = "未通过"
          break;
        case 2:
          statusInfo = "未审核"
          break;
        default:
          statusInfo = "非法状态"
          break;
      }
      tdEles[3].innerText = statusInfo;

      tdEles[5].innerHTML = '';
      if (link.status === 2) {
        const admitButton = document.createElement("input");
        admitButton.type = "button";
        admitButton.className = "table-button";
        admitButton.value = "审核通过";
        admitButton.onclick = function () {
          ajax.put("admin/link/status", {
            'id': id,
            'status': 0,
          }, function () {
            window.location.reload();
          });
        }
        tdEles[5].appendChild(admitButton);
        const rejectButton = document.createElement("input");
        rejectButton.type = "button";
        rejectButton.className = "table-button";
        rejectButton.value = "审核不通过";
        rejectButton.onclick = function () {
          ajax.put("admin/link/status", {
            'id': id,
            'status': 1,
          }, function () {
            window.location.reload();
          });
        }
        tdEles[5].appendChild(rejectButton);
      } else {
        const removeButton = document.createElement("input");
        removeButton.type = "button";
        removeButton.className = "table-button";
        removeButton.value = "删除";
        removeButton.onclick = function () {
          if (window.confirm("确认删除id为" + id + "的链接吗？")) {
            ajax.delete("admin/link/" + id, null, function () {
              window.location.reload();
            });
          }
        }
        tdEles[5].appendChild(removeButton);
      }

      const trEle = document.createElement("tr");
      for (let tdEle of tdEles) {
        trEle.appendChild(tdEle);
      }
      linkListEle.appendChild(trEle);
    }
  }

  const search = function () {
    let name = document.getElementById("name").value;
    name = name == null || name === "" ? null : name;
    const statusEle = document.getElementById("status");
    let status = statusEle.options[statusEle.selectedIndex].value;
    status = status === "-1" ? null : status;
    pager.changePageNum(1, new Map([
      ['name', name],
      ['status', status]
    ]));
  }

  window.onload = function () {
    if (!existToken()) {
      window.location.href = "../user/login.html";
    }

    pager = new Pager(pageSize, "admin/link/list", showList)
    pager.changePageNum(1);

    document.getElementById("selected-page-num").onkeydown = onChangePageNum;

    document.getElementById("search").onclick = search;
  }
</script>