<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hjdmmm博客后台</title>
  <link href="../../css/global.css" rel="stylesheet">
  <link href="../../css/common-table.css" rel="stylesheet">
  <style>
    .real-upload-button {
      display: none
    }
    img {
      max-width: 20%;
      height: auto;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="left-side">
    <ul>
      <li><a href="../article/write.html">写博文</a></li>
      <li><a href="../article/article.html">文章管理</a></li>
      <li><a href="../link/link.html">推荐网站管理</a></li>
      <li><a href="../category/category.html">分类管理</a></li>
      <li><a href="../tag/tag.html">标签管理</a></li>
      <li><a href="../user/user.html">用户管理</a></li>
      <li><a href="./image.html">图片管理</a></li>
    </ul>
  </div>
  <div class="center">
    <div class="inner-header">
      <h1>图片管理</h1>
      <input type="button" value="退出" onclick="logout('../user/login.html');">
    </div>
    <div class="inner-center">
      <div class="search">
        <span class="search-tip">名称</span> <input class="search-text" id="name" type="text">
        <input class="search-button" id="search" type="button" value="搜索">
      </div>

      <div>
        <input type="file" accept="image/*" id="real-upload-button" class="real-upload-button" onchange="uploadImage(this.files);">
        <input type="button" id="fake-button" class="add-button" value="点此上传" onclick="document.getElementById('real-upload-button').click();">
      </div>

      <div class="table">
        <table>
          <thead>
          <tr>
            <th>id</th>
            <th>原始名称</th>
            <th>文件类型(mimeType)</th>
            <th>url</th>
            <th>创建时间</th>
            <th>缩略图</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="image-list">
          </tbody>
        </table>
      </div>

      <div class="page-board">
        共<span id="total-num">0</span>条 10条/页
        <input class="page-button" id="previous-page" onclick="pager.toPreviousPage();" type="button" value="&lt;">
        <span id="show-page-num">
        </span>
        <input class="page-button" id="next-page" onclick="pager.toNextPage();" type="button" value="&gt;">
        前往 <input class="page-num" id="selected-page-num" type="text"> 页
      </div>
    </div>
  </div>
</div>
</body>
</html>

<script src="../../js/ajax.js"></script>
<script src="../../js/page.js"></script>
<script src="../../js/login.js"></script>
<script>
  const pageSize = 10;
  let pager;

  const onChangePageNum = function (e) {
    const theEvent = window.event || e;
    const code = theEvent.keyCode || theEvent.which || theEvent.charCode;
    if (code === 13) {
      pager.toSelectedPageNum(this.value);
    }
  }

  const showList = function (page) {
    document.getElementById("total-num").innerText = page.total;
    maxPageNum = Math.ceil(page.total / pageSize);
    const showPageNumEle = document.getElementById("show-page-num");
    showPageNumEle.innerHTML = '';
    for (let currentPage = 1; currentPage <= maxPageNum; currentPage++) {
      const pageNumEle = document.createElement("input");
      pageNumEle.className = "page-button";
      pageNumEle.type = "button";
      pageNumEle.value = currentPage.toString();
      const currentPageNum = currentPage;
      pageNumEle.onclick = function () {
        pager.toSelectedPageNum(currentPageNum);
      }
      showPageNumEle.appendChild(pageNumEle);
    }

    showTable(page.rows)
  }

  const showTable = function (list) {
    const imageListEle = document.getElementById("image-list");
    imageListEle.innerHTML = "";
    for (let image of list) {
      const id = image.id;
      const elementNames = ["id", "originalName", "mimeType", "url", "createTime", "thumbnail", "op"];
      const tdEles = elementNames.map(elementName => {
        const tdEle = document.createElement("td");
        tdEle.innerText = image[elementName];
        return tdEle;
      });

      tdEles[5].innerHTML = '';
      const thumbnail = document.createElement("img");
      thumbnail.src = image.thumbnail;
      thumbnail.alt = "图片加载失败";
      tdEles[5].appendChild(thumbnail);

      tdEles[6].innerHTML = '';
      const removeButton = document.createElement("input");
      removeButton.type = "button";
      removeButton.className = "table-button";
      removeButton.value = "删除";
      removeButton.onclick = function () {
        if (window.confirm("确认删除id为" + id + "的图片吗？")) {
          ajax.delete("admin/image/" + id, null, function () {
            window.location.reload();
          });
        }
      }
      tdEles[6].appendChild(removeButton);

      const trEle = document.createElement("tr");
      for (let tdEle of tdEles) {
        trEle.appendChild(tdEle);
      }
      imageListEle.appendChild(trEle);
    }
  }

  const search = function () {
    let name = document.getElementById("name").value;
    name = name == null || name === "" ? null : name;
    const statusEle = document.getElementById("status");
    let status = statusEle.options[statusEle.selectedIndex].value;
    status = status === "-1" ? null : status;
    pager.changePageNum(1, new Map([
      ['name', name],
      ['status', status]
    ]));
  }

  const uploadImage = function (files) {
    if (!files || !files[0]) {
      return;
    }

    const formData = new FormData();
    formData.append("img", files[0]);
    ajax.post("admin/image", formData, (attachmentId) => {
      window.alert("上传成功，attachmentId=" + attachmentId);
      window.location.reload();
    });
  }

  window.onload = function () {
    if (!existToken()) {
      window.location.href = "../user/login.html";
    }

    pager = new Pager(pageSize, "admin/image/list", showList)
    pager.changePageNum(1);

    document.getElementById("selected-page-num").onkeydown = onChangePageNum;

    document.getElementById("search").onclick = search;
  }
</script>