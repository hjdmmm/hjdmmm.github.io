<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>hjdmmm的博客</title>
    <link href="../css/global.css" rel="stylesheet" type="text/css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"
          rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css"
          rel="stylesheet">
    <style>
        .article {
            padding-bottom: 20px;
            border-bottom: 4px solid #d3d3d3;
        }

        .article h1 {
            margin: 10px 0;
            font-size: 25px;
            font-weight: 700;
            text-align: center;
            line-height: 30px;
        }

        .article h2 {
            margin: 10px 0;
            line-height: 24px;
            text-align: center;
            color: #555;
            font-size: 14px;
        }

        .article .category {
            text-decoration: none;
        }

        .article .category:hover {
            color: #138014;
        }

        .send-comment {
            padding-bottom: 10px;
            border-bottom: 1px solid #d3d3d3;
        }

        .send-comment h1 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .comments h1 {
            border-left: 2px solid #363d4c;
            padding: 0 10px;
            margin: 40px 0;
            font-size: 20px;
        }

        .comment {
            border-bottom: 1px solid #363d4c;
            margin-top: 20px;
            padding-bottom: 20px;
        }

        .comment h2 {
            font-size: 14px;
            margin: 5px 8px 7px 0;
            color: #444;
            font-weight: bold;
        }

        .comment h3 {
            color: #aaa;
            font-size: 12px;
        }

        .comment small {
            margin: 10px 0;
            font-size: 12px;
            color: #64609E;
            cursor: pointer;
        }

        .second-comment {
            margin-left: 60px;
        }

        .more-comments {
            margin-top: 20px;
            cursor: pointer;
            height: 30px;
            width: 60%;
            line-height: 30px;
            text-align: center;
        }

    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <span>hjdmmm的博客</span>
        <span class="article_search">
            <a href="./index.html">首页</a>
            <a href="./category.html">分类</a>
            <input size="20" type="text" disabled>
            <input type="button" value="搜索" disabled>
        </span>
    </div>
    <div class="content">
        <div class="article">
            <h1 id="article-title"></h1>
            <h2 id="article-info"></h2>
            <div class="markdown-body" id="article-content"></div>
        </div>

        <div>
            <div class="send-comment">
                <h1>发表评论</h1>
                <textarea autocomplete="off" cols="50" id="send-comment-content" placeholder="在此填写评论"
                          rows="10"></textarea>
                <div><input id="send-comment-button" type="button" value="发表"></div>
            </div>
            <div class="comments" id="comments">
                <h1 id="comment-total">回复0条</h1>
            </div>
            <input class="more-comments" id="more-comments" onclick="getComment()" type="button" value="显示更多" disabled>
        </div>
    </div>
    <div class="footer">
        <p>
            <a href="https://gitee.com/hjdmmm" target="_blank">Gitee</a>
        </p>
        <p>Email: <a href="mailto:office404@qq.com" target="_blank">office404@qq.com</a></p>
    </div>
</div>
</body>
</html>

<!-- 解析Markdown，语法高亮 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/5.1.1/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script src="../js/url.js"></script>
<script src="../js/ajax.js"></script>
<script src="../js/time.js"></script>
<script>
    let articleId = -1;
    let pageNum = 1;

    const showArticle = function (articleDetail) {
        document.title = articleDetail.title + " - hjdmmm的博客"
        const createTime = new Date(Date.parse(articleDetail.createTime));
        document.getElementById("article-title").innerText = articleDetail.title;
        document.getElementById("article-info").innerHTML = `
            ${articleDetail.nickName} •
            发表于${getChineseDate(createTime)} •
            ${articleDetail.viewCount}次浏览 •
            <a class="category" href="category.html?id=${articleDetail.categoryId}">分类：${articleDetail.categoryName}</a>
        `;
        document.getElementById("article-content").innerHTML = marked.parse(articleDetail.content,
            {
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, {language}).value;
                },
                breaks: true,
            });
    }

    const showComments = function (page) {
        document.getElementById("comment-total").innerText = "回复" + page.total + "条";

        const moreCommentsEle = document.getElementById("more-comments");
        if (pageNum * 10 > page.total) {
            moreCommentsEle.disabled = true;
            moreCommentsEle.title = "没有更多评论";
        } else {
            moreCommentsEle.disabled = false;
            moreCommentsEle.title = "";
        }

        pageNum++;

        const commentsEle = document.getElementById("comments");
        for (let comment of page.rows) {
            const commentEleId = 'comment-' + comment.id
            const commentEle = document.createElement("div");
            commentEle.id = commentEleId;
            commentEle.className = "comment";
            commentEle.innerHTML = `
                <h2>${comment.nickName}</h2>
                <h3>${comment.createTime}</h3>
                <p>${comment.content}</p>
                <small onclick="showReplyToElement('${commentEleId}', '${comment.id}', '${comment.id}', '${comment.createBy}')">回复</small>
            `;
            commentsEle.appendChild(commentEle);
            for (let child of comment.children) {
                const childEleId = 'comment-' + child.id
                const childEle = document.createElement("div");
                childEle.id = childEleId;
                childEle.className = "comment second-comment";
                childEle.innerHTML = `
                    <h2>${child.nickName} 回复 ${child.toCommentUserNickName}</h2>
                    <h3>${child.createTime}</h3>
                    <p>${child.content}</p>
                    <small onclick="showReplyToElement('${childEleId}', '${child.pid}', '${child.id}', '${child.createBy}')">回复</small>
                `;
                commentsEle.appendChild(childEle);
            }
        }
    }

    const getComment = function () {
        const commentQuery = {
            'articleId': articleId,
            'pageNum': pageNum,
        }
        ajax.get("comment/article", commentQuery, showComments);
    }

    const sendComment = function (content, pid, toCommentId, toCommentUserId) {
        const comment = {
            'articleId': articleId,
            'content': content,
            'pid': pid,
            'toCommentId': toCommentId,
            'toCommentUserId': toCommentUserId,
            'type': 0,
        };
        ajax.post("comment", comment, function () {
            window.alert("发送成功");
            window.location.reload();
        });
    }

    const showReplyToElement = function (commentEleId, pid, toCommentId, toCommentUserId) {
        const oldReplyToEle = document.getElementById("reply-to");
        if (oldReplyToEle !== null) {
            oldReplyToEle.remove();
        }
        const replyToEle = document.createElement("div");
        replyToEle.id = "reply-to";
        replyToEle.innerHTML = `
            <div class="send-comment">
                <h1>发表评论</h1>
                <textarea placeholder="在此填写评论" rows="10" cols="50" autocomplete="off" id="reply-comment-content"></textarea>
                <div><input type="button" value="发表" onclick="replyTo('${pid}', '${toCommentId}', '${toCommentUserId}')"></div>
            </div>
        `;
        document.getElementById(commentEleId).appendChild(replyToEle);
    }

    const replyTo = function (pid, toCommentId, toCommentUserId) {
        const content = document.getElementById("reply-comment-content").value;
        sendComment(content, pid, toCommentId, toCommentUserId);
    }

    window.onload = function () {
        articleId = getUrlParam(window.location.search, "id");
        ajax.get("article/" + articleId, null, showArticle);
        getComment();

        document.getElementById("send-comment-button").onclick = function () {
            const content = document.getElementById("send-comment-content").value;
            sendComment(content, -1, -1, -1);
        }

        ajax.put("article/viewCount/" + articleId, null, null);
    }
</script>